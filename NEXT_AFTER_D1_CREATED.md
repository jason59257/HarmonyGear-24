# D1 æ•°æ®åº“å·²åˆ›å»º - æ¥ä¸‹æ¥çš„æ­¥éª¤

## âœ… å·²å®Œæˆ
- D1 æ•°æ®åº“å·²åˆ›å»º

## ğŸ“‹ æ¥ä¸‹æ¥çš„æ­¥éª¤

### æ­¥éª¤ 1: åˆå§‹åŒ–æ•°æ®åº“è¡¨

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ‰€æœ‰è¡¨ï¼š

```bash
cd /Users/mac/Desktop/coupon-website
npm run wrangler -- d1 execute coupon-db --file=./schema.sql
```

**é‡è¦æç¤ºï¼š**
- ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
- åªå¤åˆ¶å‘½ä»¤æœ¬èº«ï¼Œä¸è¦åŒ…å« ```bash æ ‡è®°
- å¦‚æœçœ‹åˆ°é”™è¯¯ï¼Œå‘Šè¯‰æˆ‘å…·ä½“é”™è¯¯ä¿¡æ¯

**é¢„æœŸç»“æœï¼š**
```
âœ… Successfully executed 15 commands
```

---

### æ­¥éª¤ 2: éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰è¡¨ï¼š

```bash
npm run wrangler -- d1 execute coupon-db --command="SELECT name FROM sqlite_master WHERE type='table';"
```

**é¢„æœŸç»“æœï¼š**
åº”è¯¥çœ‹åˆ° 8 ä¸ªè¡¨ï¼š
- users
- stores
- coupons
- categories
- user_cashback
- coupon_usage
- products
- admin_users

---

### æ­¥éª¤ 3: è·å– database_id

å¦‚æœä½ è¿˜æ²¡æœ‰ä¿å­˜ database_idï¼Œæ‰§è¡Œï¼š

```bash
npm run wrangler -- d1 list
```

**é¢„æœŸç»“æœï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name       â”‚ id                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ coupon-db  â”‚ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦ï¼š** å¤åˆ¶ `id` åˆ—çš„å€¼ï¼ˆdatabase_idï¼‰ï¼Œç¨åéœ€è¦ç”¨åˆ°ï¼

---

### æ­¥éª¤ 4: ç”Ÿæˆ JWT_SECRET

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆéšæœºå¯†é’¥ï¼š

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

**é¢„æœŸç»“æœï¼š**
ä¼šæ˜¾ç¤ºä¸€ä¸ª 64 ä¸ªå­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š
```
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
```

**é‡è¦ï¼š** å¤åˆ¶è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œç¨åéœ€è¦ç”¨åˆ°ï¼

---

### æ­¥éª¤ 5: æ›´æ–° wrangler.toml

ç¼–è¾‘ `wrangler.toml` æ–‡ä»¶ï¼Œæ›´æ–°ä»¥ä¸‹å†…å®¹ï¼š

1. **æ‰¾åˆ°æˆ–æ·»åŠ  D1 æ•°æ®åº“é…ç½®**ï¼š
```toml
[[d1_databases]]
binding = "DB"
database_name = "coupon-db"
database_id = "è¿™é‡Œå¡«å…¥æ­¥éª¤3å¤åˆ¶çš„database_id"  # â¬…ï¸ æ›¿æ¢è¿™é‡Œ
```

2. **æ·»åŠ ç¯å¢ƒå˜é‡**ï¼š
```toml
[vars]
JWT_SECRET = "è¿™é‡Œå¡«å…¥æ­¥éª¤4ç”Ÿæˆçš„å¯†é’¥"  # â¬…ï¸ æ›¿æ¢è¿™é‡Œ
R2_PUBLIC_URL = "https://pub-xxxxx.r2.dev"  # ç¨åé…ç½® R2 åæ›´æ–°
```

**ä¿å­˜æ–‡ä»¶**

---

### æ­¥éª¤ 6: å®‰è£… JWT åº“

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npm install @tsndr/cloudflare-worker-jwt
```

**é¢„æœŸç»“æœï¼š**
```
+ @tsndr/cloudflare-worker-jwt@2.0.0
added 1 package
```

---

## ğŸ¯ å®Œæˆä»¥ä¸Šæ­¥éª¤åå‘Šè¯‰æˆ‘

å‘Šè¯‰æˆ‘ï¼š
1. âœ… æ­¥éª¤ 1 æ˜¯å¦æˆåŠŸï¼ˆè¡¨æ˜¯å¦åˆ›å»ºï¼‰
2. âœ… æ­¥éª¤ 2 æ˜¯å¦çœ‹åˆ° 8 ä¸ªè¡¨
3. ğŸ“‹ ä½ çš„ database_idï¼ˆå¯ä»¥ç§ä¿¡æˆ–ç¨åé…ç½®ï¼‰
4. ğŸ“‹ ä½ çš„ JWT_SECRETï¼ˆå¯ä»¥ç§ä¿¡æˆ–ç¨åé…ç½®ï¼‰

**ç„¶åæˆ‘ä¼šå¸®ä½ ï¼š**
1. åˆ›å»ºå®Œæ•´çš„ API Worker ä»£ç 
2. åˆ›å»ºè®¤è¯ç³»ç»Ÿ
3. åˆ›å»ºç®¡ç†å‘˜è´¦å·è„šæœ¬
4. æ›´æ–°å‰ç«¯ä»£ç 

---

## âš ï¸ å¦‚æœæ­¥éª¤ 1 å¤±è´¥

å¦‚æœæ‰§è¡Œ schema.sql æ—¶å‡ºé”™ï¼Œå‘Šè¯‰æˆ‘ï¼š
1. å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
2. ä½ æ‰§è¡Œçš„ç¡®åˆ‡å‘½ä»¤

æˆ‘ä¼šå¸®ä½ è§£å†³ï¼
